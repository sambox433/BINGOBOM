<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO BOM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #ff4500;
        }
        .screen {
            display: none;
        }
        .active {
            display: block;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #32cd32;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #228b22;
        }
        .notification {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .success { background: #90ee90; }
        .error { background: #ff6347; }
        .loading { background: #ffd700; }
        .card-section {
            margin-top: 20px;
        }
        .card {
            background: #fffacd;
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .neo-card {
            background: #f0f8ff;
            border-radius: 10px;
            box-shadow: 5px 5px 10px #d3dbe3,
                        -5px -5px 10px #ffffff;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .ball {
            width: 30px;
            height: 30px;
            background: #ff4500;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        #qr-scanner {
            width: 100%;
            height: 300px;
            background: black;
        }
        #payment-qr {
            text-align: center;
        }
        #countdown {
            text-align: center;
            font-size: 18px;
            color: #ff4500;
        }
        #saved-sorteios {
            margin-top: 10px;
        }
        .sorteio-item {
            background: #eee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sorteio-item:hover {
            background: #ddd;
        }
        .remove-btn {
            background: #ff4500;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .remove-btn:hover {
            background: #cc3700;
        }
        #name-prompt-screen {
            display: none;
        }
        #name-prompt-screen.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BINGO BOM</h1>
        <!-- Tela de Login -->
        <div id="login-screen" class="screen active">
            <input type="text" id="login-username" placeholder="Usuário">
            <input type="password" id="login-password" placeholder="Senha">
            <button onclick="login()">Login</button>
            <button onclick="showRegister()">Cadastrar</button>
        </div>
        <!-- Tela de Cadastro -->
        <div id="register-screen" class="screen">
            <input type="text" id="reg-username" placeholder="Usuário">
            <input type="password" id="reg-password" placeholder="Senha">
            <input type="text" id="reg-phone" placeholder="Telefone">
            <button onclick="register()">Cadastrar</button>
            <button onclick="showLogin()">Voltar ao Login</button>
        </div>
        <!-- Tela Principal -->
        <div id="main-screen" class="screen">
            <h2>Bem-vindo, <span id="user-name"></span></h2>
            <input type="text" id="manual-id" placeholder="ID do Sorteio">
            <button onclick="promptForNameAfterManual()">Buscar</button>
            <button onclick="startQrScanner()">Escanear QR Code</button>
            <video id="qr-scanner" autoplay playsinline style="display: none;"></video>
            <canvas id="qr-canvas" style="display:none;"></canvas>
            <h2>Sorteios Salvos</h2>
            <div id="saved-sorteios"></div>
            <button onclick="startMonitoring()">Monitorar Sorteio (Atualiza a cada 20s)</button>
            <div class="card-section">
                <h2>Cartelas Compradas</h2>
                <div id="purchased-cards"></div>
            </div>
            <div class="card-section">
                <h2>Cartelas Disponíveis</h2>
                <div id="available-cards"></div>
            </div>
        </div>
        <!-- Tela de Pagamento -->
        <div id="payment-screen" class="screen">
            <div id="payment-qr"></div>
            <button onclick="copyPixCode()">Copiar Chave PIX</button>
            <div id="countdown"></div>
        </div>
        <!-- Tela de Prompt para Nome -->
        <div id="name-prompt-screen" class="screen">
            <h2>Insira o Nome do Sorteio</h2>
            <input type="text" id="sorteio-name" placeholder="Nome do Sorteio">
            <button onclick="saveSorteioWithName()">Salvar</button>
        </div>
        <div id="notification" class="notification"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let userData = null;
        let userPassword = '';
        let pointId = localStorage.getItem('pointId');
        let tempId = '';
        let scannerInterval = null;
        let paymentTimer = null;
        let checkInterval = null;
        let pixCode = '';
        let drawnBalls = []; // Armazena como strings com zero à esquerda (ex: "01", "10")
        let monitoringInterval = null;

        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            setTimeout(() => { notif.textContent = ''; notif.className = 'notification'; }, 5000);
        }
        function showLoading(show = true) {
            const notif = document.getElementById('notification');
            notif.textContent = show ? 'Carregando...' : '';
            notif.className = show ? 'notification loading' : 'notification';
        }
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        function showLogin() { showScreen('login-screen'); }
        function showRegister() { showScreen('register-screen'); }
        function showMain() {
            showScreen('main-screen');
            renderSaved();
            if (userData) {
                document.getElementById('user-name').textContent = userData.nome;
                renderPurchasedCards();
            }
            if (pointId) {
                fetchAvailableCards();
            }
        }
        function showPayment() { showScreen('payment-screen'); }
        function showNamePrompt() { showScreen('name-prompt-screen'); }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if (!username || !password) return showNotification('Preencha os campos', 'error');
            showLoading();
            const url = `https://script.google.com/macros/s/AKfycbwjq0it1ckhmb8mufjzPx-N3vpWoB1_RAW2stGlLCJ9CeU-Xt1YD5Uo0w0vMtIGao1z/exec?acao=login&nome=${username}&senha=${password}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showLoading(false);
                if (data.status) {
                    userData = data;
                    userPassword = password;
                    showMain();
                    if (pointId) {
                        await fetchAndUpdateBalls(); // Busca bolas ao logar se já tiver sorteio
                    }
                } else {
                    showNotification('Login falhou', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Erro na conexão', 'error');
            }
        }

        // register, QR scanner, etc... (tudo igual ao original)

        async function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const phone = document.getElementById('reg-phone').value;
            if (!username || !password || !phone) return showNotification('Preencha os campos', 'error');
            showLoading();
            const url = `https://script.google.com/macros/s/AKfycbwjq0it1ckhmb8mufjzPx-N3vpWoB1_RAW2stGlLCJ9CeU-Xt1YD5Uo0w0vMtIGao1z/exec?acao=cadastrar&nome=${username}&senha=${password}&telefone=${phone}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showLoading(false);
                if (data.status) {
                    showNotification('Cadastrado com sucesso');
                    showLogin();
                } else {
                    showNotification('Cadastro falhou', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Erro na conexão', 'error');
            }
        }

        // Funções de QR e seleção de sorteio (mantidas com chamada ao fetchAndUpdateBalls)

        function startQrScanner() { /* igual ao original */ }
        function scanQr(video, canvas, ctx) { /* igual */ }
        function stopScanner() { /* igual */ }

        function promptForNameAfterManual() {
            const id = document.getElementById('manual-id').value.trim();
            if (id) {
                tempId = id;
                showNamePrompt();
            } else {
                showNotification('Insira o ID', 'error');
            }
        }

        async function saveSorteioWithName() {
            const name = document.getElementById('sorteio-name').value.trim();
            if (!name) return showNotification('Insira o nome', 'error');
            await setSorteio(tempId, name);
            showMain();
            await fetchAndUpdateBalls(); // Busca bolas após salvar
        }

        async function setSorteio(newId, newName) {
            pointId = newId;
            localStorage.setItem('pointId', pointId);
            let saved = JSON.parse(localStorage.getItem('savedSorteios') || '[]');
            if (!saved.find(s => s.id === newId)) {
                saved.push({id: newId, name: newName});
                localStorage.setItem('savedSorteios', JSON.stringify(saved));
                renderSaved();
            }
            await fetchAvailableCards();
            showNotification(`Sorteio "${newName}" (ID: ${newId}) salvo!`);
        }

        function renderSaved() {
            const container = document.getElementById('saved-sorteios');
            container.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('savedSorteios') || '[]');
            saved.forEach(sorteio => {
                const div = document.createElement('div');
                div.className = 'sorteio-item';
                const textSpan = document.createElement('span');
                textSpan.textContent = `${sorteio.name} (ID: ${sorteio.id})`;
                textSpan.style.cursor = 'pointer';
                textSpan.onclick = async () => {
                    pointId = sorteio.id;
                    localStorage.setItem('pointId', pointId);
                    await fetchAvailableCards();
                    await fetchAndUpdateBalls(); // Busca bolas ao clicar no salvo
                    showNotification(`Sorteio carregado: ${sorteio.name}`);
                };
                div.appendChild(textSpan);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Remover';
                removeBtn.onclick = () => removeSorteio(sorteio.id);
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }

        // removeSorteio, fetchAvailableCards, renderPurchasedCards, renderAvailableCards (iguais)

        function createCard(cartelaStr, isAvailable) {
            cartelaStr = cartelaStr.replace(/\[|\]/g, '').trim();
            const div = document.createElement('div');
            div.className = isAvailable ? 'card' : 'neo-card';
            const numbers = cartelaStr.split(' ').map(n => n.trim()).filter(n => n);
            numbers.forEach(num => {
                const ball = document.createElement('div');
                ball.className = 'ball';
                // Mostra com zero à esquerda se tiver (ex: 01 → 01, 1 → 1)
                ball.textContent = num.padStart(2, '0');
                // Compara com zero à esquerda para garantir match (ex: "1" e "01" viram "01")
                if (drawnBalls.includes(num.padStart(2, '0'))) {
                    ball.style.background = 'green';
                } else {
                    ball.style.background = '#ff4500';
                }
                div.appendChild(ball);
            });
            if (isAvailable) {
                const buyBtn = document.createElement('button');
                buyBtn.textContent = 'Comprar';
                buyBtn.onclick = () => buyCard(cartelaStr);
                div.appendChild(buyBtn);
            }
            return div;
        }

        // buyCard, generateQrCode, copyPixCode, startCountdown, startPaymentCheck (iguais)

        // *** NOVA FUNÇÃO CORRIGIDA PARA A API CERTA ***
        async function fetchDrawnBalls(id) {
            const url = `https://script.google.com/macros/s/AKfycbz0QT61hVX-h35nLIvytrKGC33TnLXzi_F4mWoN0BaJZEpnLKNVh2kyzpMSGS_Sb3zi/exec?acao=consultar&id=${id}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.status && data.numeros) {
                    let bolasStr = data.numeros.replace(/\(|\)/g, '').trim();
                    return bolasStr.split(' ')
                        .filter(b => b.trim())
                        .map(b => b.trim().padStart(2, '0')); // Garante "01", "02", etc.
                }
                return [];
            } catch (err) {
                console.error(err);
                return drawnBalls; // Mantém as anteriores em caso de erro
            }
        }

        async function fetchAndUpdateBalls() {
            if (!pointId) return;
            const balls = await fetchDrawnBalls(pointId);
            drawnBalls = balls; // Agora com formato "01", "02", "10"...
            renderPurchasedCards();
            await fetchAvailableCards(); // Re-renderiza com marcação correta
        }

        function startMonitoring() {
            if (!pointId) return showNotification('Selecione um sorteio primeiro', 'error');
            if (monitoringInterval) clearInterval(monitoringInterval);
            fetchAndUpdateBalls();
            monitoringInterval = setInterval(fetchAndUpdateBalls, 20000); // 20 segundos
            showNotification('Monitoramento iniciado! Atualizando a cada 20 segundos.');
        }

        if (userData) showMain();
    </script>
</body>
</html>
