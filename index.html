<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BINGO BOM</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #ff4500;
        }
        .screen {
            display: none;
        }
        .active {
            display: block;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #32cd32;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #228b22;
        }
        .notification {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .success { background: #90ee90; }
        .error { background: #ff6347; }
        .loading { background: #ffd700; }
        .card-section {
            margin-top: 20px;
        }
        .card {
            background: #fffacd;
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .neo-card {
            background: #f0f8ff;
            border-radius: 10px;
            box-shadow: 5px 5px 10px #d3dbe3,
                        -5px -5px 10px #ffffff;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .ball {
            width: 30px;
            height: 30px;
            background: #ff4500;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        #qr-scanner {
            width: 100%;
            height: 300px;
            background: black;
        }
        #payment-qr {
            text-align: center;
        }
        #countdown {
            text-align: center;
            font-size: 18px;
            color: #ff4500;
        }
        #saved-sorteios {
            margin-top: 10px;
        }
        .sorteio-item {
            background: #eee;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sorteio-item:hover {
            background: #ddd;
        }
        .remove-btn {
            background: #ff4500;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .remove-btn:hover {
            background: #cc3700;
        }
        #name-prompt-screen {
            display: none;
        }
        #name-prompt-screen.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BINGO BOM</h1>
        <!-- Tela de Login -->
        <div id="login-screen" class="screen active">
            <input type="text" id="login-username" placeholder="Usuário">
            <input type="password" id="login-password" placeholder="Senha">
            <button onclick="login()">Login</button>
            <button onclick="showRegister()">Cadastrar</button>
        </div>
        <!-- Tela de Cadastro -->
        <div id="register-screen" class="screen">
            <input type="text" id="reg-username" placeholder="Usuário">
            <input type="password" id="reg-password" placeholder="Senha">
            <input type="text" id="reg-phone" placeholder="Telefone">
            <button onclick="register()">Cadastrar</button>
            <button onclick="showLogin()">Voltar ao Login</button>
        </div>
        <!-- Tela Principal -->
        <div id="main-screen" class="screen">
            <h2>Bem-vindo, <span id="user-name"></span></h2>
            <input type="text" id="manual-id" placeholder="ID do Sorteio">
            <button onclick="promptForNameAfterManual()">Buscar</button>
            <button onclick="startQrScanner()">Escanear QR Code</button>
            <video id="qr-scanner" autoplay playsinline style="display: none;"></video>
            <canvas id="qr-canvas" style="display:none;"></canvas>
            <h2>Sorteios Salvos</h2>
            <div id="saved-sorteios"></div>
            <button id="auto-btn" onclick="toggleAuto()">Ativar Verificação Automática (a cada 10s)</button>
            <div class="card-section">
                <h2>Cartelas Compradas</h2>
                <div id="purchased-cards"></div>
            </div>
            <div class="card-section">
                <h2>Cartelas Disponíveis</h2>
                <div id="available-cards"></div>
            </div>
        </div>
        <!-- Tela de Pagamento -->
        <div id="payment-screen" class="screen">
            <div id="payment-qr"></div>
            <button onclick="copyPixCode()">Copiar Chave PIX</button>
            <div id="countdown"></div>
        </div>
        <!-- Tela de Prompt para Nome -->
        <div id="name-prompt-screen" class="screen">
            <h2>Insira o Nome do Sorteio</h2>
            <input type="text" id="sorteio-name" placeholder="Nome do Sorteio">
            <button onclick="saveSorteioWithName()">Salvar</button>
        </div>
        <div id="notification" class="notification"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let userData = null;
        let userPassword = '';
        let pointId = localStorage.getItem('pointId');
        let tempId = '';
        let scannerInterval = null;
        let paymentTimer = null;
        let checkInterval = null;
        let pixCode = '';
        let drawnBalls = [];
        let monitoringInterval = null;
        let autoMode = false;
        let manualDrawn = [];
        const API_URL = 'https://script.google.com/macros/s/AKfycbz0QT61hVX-h35nLIvytrKGC33TnLXzi_F4mWoN0BaJZEpnLKNVh2kyzpMSGS_Sb3zi/exec';
        function showNotification(message, type = 'success') {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.className = `notification ${type}`;
            setTimeout(() => { notif.textContent = ''; notif.className = 'notification'; }, 5000);
        }
        function showLoading(show = true) {
            const notif = document.getElementById('notification');
            notif.textContent = show ? 'Carregando...' : '';
            notif.className = show ? 'notification loading' : 'notification';
        }
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        function showLogin() {
            showScreen('login-screen');
        }
        function showRegister() {
            showScreen('register-screen');
        }
        function showMain() {
            showScreen('main-screen');
            renderSaved();
            if (userData) {
                document.getElementById('user-name').textContent = userData.nome;
                renderPurchasedCards();
            }
            if (pointId) {
                fetchSorteioData();
            }
        }
        function showPayment() {
            showScreen('payment-screen');
        }
        function showNamePrompt() {
            showScreen('name-prompt-screen');
        }
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            if (!username || !password) return showNotification('Preencha os campos', 'error');
            showLoading();
            const url = `https://script.google.com/macros/s/AKfycbwjq0it1ckhmb8mufjzPx-N3vpWoB1_RAW2stGlLCJ9CeU-Xt1YD5Uo0w0vMtIGao1z/exec?acao=login&nome=${username}&senha=${password}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showLoading(false);
                if (data.status) {
                    userData = data;
                    userPassword = password;
                    showMain();
                    if (pointId) {
                        await fetchSorteioData();
                    }
                } else {
                    showNotification('Login falhou', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Erro na conexão', 'error');
            }
        }
        async function register() {
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const phone = document.getElementById('reg-phone').value;
            if (!username || !password || !phone) return showNotification('Preencha os campos', 'error');
            showLoading();
            const url = `https://script.google.com/macros/s/AKfycbwjq0it1ckhmb8mufjzPx-N3vpWoB1_RAW2stGlLCJ9CeU-Xt1YD5Uo0w0vMtIGao1z/exec?acao=cadastrar&nome=${username}&senha=${password}&telefone=${phone}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showLoading(false);
                if (data.status) {
                    showNotification('Cadastrado com sucesso');
                    showLogin();
                } else {
                    showNotification('Cadastro falhou', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Erro na conexão', 'error');
            }
        }
        function startQrScanner() {
            const video = document.getElementById('qr-scanner');
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    scannerInterval = setInterval(() => scanQr(video, canvas, ctx), 100);
                })
                .catch(err => showNotification('Erro ao acessar câmera', 'error'));
            video.style.display = 'block';
        }
        function scanQr(video, canvas, ctx) {
            if (video.videoWidth === 0) return;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                tempId = code.data;
                stopScanner();
                showNamePrompt();
            }
        }
        function stopScanner() {
            clearInterval(scannerInterval);
            const video = document.getElementById('qr-scanner');
            video.srcObject.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
        }
        function promptForNameAfterManual() {
            const id = document.getElementById('manual-id').value;
            if (id) {
                tempId = id;
                showNamePrompt();
            } else {
                showNotification('Insira o ID', 'error');
            }
        }
        async function saveSorteioWithName() {
            const name = document.getElementById('sorteio-name').value;
            if (!name) return showNotification('Insira o nome', 'error');
            await setSorteio(tempId, name);
            showMain();
            await fetchSorteioData();
        }
        async function setSorteio(newId, newName) {
            pointId = newId;
            localStorage.setItem('pointId', pointId);
            let saved = JSON.parse(localStorage.getItem('savedSorteios') || '[]');
            if (!saved.find(s => s.id === newId)) {
                saved.push({id: newId, name: newName});
                localStorage.setItem('savedSorteios', JSON.stringify(saved));
                renderSaved();
            }
            await fetchSorteioData();
            showNotification(`Sorteio "${newName}" (ID: ${newId}) salvo!`);
        }
        function renderSaved() {
            const container = document.getElementById('saved-sorteios');
            container.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('savedSorteios') || '[]');
            saved.forEach(sorteio => {
                const div = document.createElement('div');
                div.className = 'sorteio-item';
                const textSpan = document.createElement('span');
                textSpan.textContent = `${sorteio.name} (ID: ${sorteio.id})`;
                textSpan.style.cursor = 'pointer';
                textSpan.onclick = async () => {
                    pointId = sorteio.id;
                    await fetchSorteioData();
                    showNotification(`Carregando sorteio: ${sorteio.name}`);
                };
                div.appendChild(textSpan);
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.textContent = 'Remover';
                removeBtn.onclick = () => removeSorteio(sorteio.id);
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }
        function removeSorteio(id) {
            let saved = JSON.parse(localStorage.getItem('savedSorteios') || '[]');
            saved = saved.filter(s => s.id !== id);
            localStorage.setItem('savedSorteios', JSON.stringify(saved));
            if (pointId === id) {
                pointId = null;
                localStorage.removeItem('pointId');
                drawnBalls = [];
                document.getElementById('purchased-cards').innerHTML = '';
                document.getElementById('available-cards').innerHTML = '';
            }
            renderSaved();
            showNotification('Sorteio removido!');
        }
        async function fetchSorteioData() {
            if (!pointId) return showNotification('Selecione um sorteio primeiro', 'error');
            showLoading();
            const url = `${API_URL}?acao=consultar&id=${pointId}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showLoading(false);
                if (data.status) {
                    drawnBalls = data.bolas_saidas.flatMap(s => s.split(' ').filter(b => b.trim()).map(b => b.trim()));
                    renderAvailableCards(data.cartelas_a_venda);
                    renderPurchasedCards();
                } else {
                    showNotification('Erro ao carregar dados', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Erro na conexão', 'error');
            }
        }
        function renderPurchasedCards() {
            const container = document.getElementById('purchased-cards');
            container.innerHTML = '';
            if (userData && userData.cartelas_compradas) {
                userData.cartelas_compradas.forEach(cartela => {
                    const card = createCard(cartela, false);
                    container.appendChild(card);
                });
            }
        }
        function renderAvailableCards(cartelas) {
            const container = document.getElementById('available-cards');
            container.innerHTML = '';
            cartelas.forEach(cartela => {
                const card = createCard(cartela, true);
                container.appendChild(card);
            });
        }
        function createCard(cartelaStr, isAvailable) {
            cartelaStr = cartelaStr.replace(/\[|\]/g, '').trim();
            const div = document.createElement('div');
            div.className = isAvailable ? 'card' : 'neo-card';
            const numbers = cartelaStr.split(' ');
            const usedBalls = autoMode ? drawnBalls : manualDrawn;
            numbers.forEach(num => {
                num = num.trim();
                if (num) {
                    const ball = document.createElement('div');
                    ball.className = 'ball';
                    ball.textContent = num;
                    ball.style.background = usedBalls.includes(num) ? 'green' : '#ff4500';
                    if (!isAvailable) {
                        ball.onclick = function() {
                            if (!autoMode) {
                                toggleMark(num);
                            }
                        };
                    }
                    div.appendChild(ball);
                }
            });
            if (isAvailable) {
                const buyBtn = document.createElement('button');
                buyBtn.textContent = 'Comprar';
                buyBtn.onclick = () => buyCard(cartelaStr);
                div.appendChild(buyBtn);
            }
            return div;
        }
        function toggleMark(num) {
            if (manualDrawn.includes(num)) {
                manualDrawn = manualDrawn.filter(n => n !== num);
            } else {
                manualDrawn.push(num);
            }
            renderPurchasedCards();
        }
        async function buyCard(cartela) {
            if (!userData || !pointId) return showNotification('Login ou sorteio necessário', 'error');
            showLoading();
            const url = `https://script.google.com/macros/s/AKfycbxVLVo_YV_Lpw9uY5KwZV-ovxaLYj8LfRp9sctC5pYK2K0wzxWLpZYftB9RqAOObK9D/exec?acao=criar_pix&id=${pointId}&nome=${userData.nome}&senha=${userPassword}&cartela=${cartela}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                showLoading(false);
                if (data.status) {
                    pixCode = data.dados.pix_copia_cola;
                    generateQrCode(pixCode);
                    showPayment();
                    startCountdown(data.dados.expira_em);
                    startPaymentCheck(data.dados.payment_id);
                } else {
                    showNotification('Erro ao criar PIX', 'error');
                }
            } catch (err) {
                showLoading(false);
                showNotification('Erro na conexão', 'error');
            }
        }
        function generateQrCode(text) {
            const qrContainer = document.getElementById('payment-qr');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, text);
        }
        function copyPixCode() {
            navigator.clipboard.writeText(pixCode).then(() => showNotification('PIX copiado!'));
        }
        function startCountdown(expireTimestamp) {
            const countdownEl = document.getElementById('countdown');
            const now = Date.now();
            let remaining = Math.max(0, (expireTimestamp - now) / 1000);
            if (remaining > 420) remaining = 420; // Max 7 min
            paymentTimer = setInterval(() => {
                if (remaining <= 0) {
                    clearInterval(paymentTimer);
                    showNotification('Tempo expirado', 'error');
                    showMain();
                    return;
                }
                const min = Math.floor(remaining / 60);
                const sec = Math.floor(remaining % 60);
                countdownEl.textContent = `Expira em: ${min}:${sec < 10 ? '0' : ''}${sec}`;
                remaining--;
            }, 1000);
        }
        function startPaymentCheck(paymentId) {
            checkInterval = setInterval(async () => {
                const url = `https://script.google.com/macros/s/AKfycbzf4BL9cPy22cC808fLHMomgnnjffzvacRMp0iYCR73gtjFS0XAqxZWSyPNGdEtek0X/exec?acao=confirmar_pix&id=${pointId}&payment_id=${paymentId}&nome=${userData.nome}&senha=${userPassword}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.status && data.dados.mensagem === 'Pagamento confirmado e cartela liberada') {
                        clearInterval(checkInterval);
                        clearInterval(paymentTimer);
                        showNotification('Pagamento confirmado!', 'success');
                        await login(); // Relogin para atualizar userData com novas cartelas
                        await fetchSorteioData(); // Atualiza bolas e marca nas cartelas
                        showMain(); // Retorna para a tela principal com cartelas atualizadas
                    }
                } catch (err) {}
            }, 7000); // 10 seconds
        }
        function toggleAuto() {
            if (autoMode) {
                clearInterval(monitoringInterval);
                manualDrawn = [...drawnBalls];
                autoMode = false;
                document.getElementById('auto-btn').textContent = 'Ativar Verificação Automática (a cada 10s)';
                showNotification('Modo manual ativado. Clique nos números para marcar.');
                renderPurchasedCards();
            } else {
                autoMode = true;
                fetchSorteioData();
                monitoringInterval = setInterval(fetchSorteioData, 10000);
                document.getElementById('auto-btn').textContent = 'Desativar Verificação Automática';
                showNotification('Modo automático ativado! Atualizando a cada 10 segundos.');
                renderPurchasedCards();
            }
        }
        if (userData) showMain();
    </script>
</body>
</html>



